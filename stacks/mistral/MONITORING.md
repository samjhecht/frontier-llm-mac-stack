# Mistral.rs Monitoring Integration

This document describes the monitoring setup for Mistral.rs in the Frontier LLM Stack.

## Overview

The Mistral.rs monitoring integration provides:
- Prometheus metrics collection
- Grafana dashboards for visualization
- Alerting rules for operational issues
- Performance metrics for inference operations

## Architecture

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐
│   Mistral.rs    │────▶│  Ollama Proxy    │────▶│ Prometheus  │
│   (port 8080)   │     │  (port 11434)    │     │ (port 9090) │
└─────────────────┘     └──────────────────┘     └─────────────┘
                               │                         │
                               ▼                         ▼
                        /metrics endpoint          ┌─────────────┐
                        /api/metrics              │   Grafana   │
                                                  │ (port 3000) │
                                                  └─────────────┘
```

## Metrics Exposed

The Mistral.rs Ollama proxy exposes the following Prometheus metrics:

### HTTP Metrics
- `mistral_http_requests_total` - Total HTTP requests by endpoint and status
- `mistral_http_request_duration_seconds` - Request latency histogram by endpoint
- `mistral_active_requests` - Current number of active requests

### Generation Metrics
- `mistral_generate_duration_seconds` - Time spent generating responses by model
- `mistral_generate_tokens_total` - Total tokens generated by model
- `mistral_streaming_chunks_total` - Total streaming chunks sent by endpoint

### Model Metrics
- `mistral_model_load_duration_seconds` - Time taken to load models

## Configuration

### Prometheus Configuration

The Prometheus scrape configuration is located at:
`stacks/common/monitoring/config/prometheus/prometheus.yml`

```yaml
- job_name: 'mistral'
  metrics_path: '/metrics'
  scrape_timeout: 10s
  honor_labels: true
  static_configs:
    - targets: ['frontier-mistral-ollama-proxy:11434']
      labels:
        engine: 'mistral'
        engine_type: 'inference'
```

### Grafana Dashboard

A dedicated Mistral.rs dashboard is available at:
`stacks/common/monitoring/config/grafana/dashboards/mistral-metrics.json`

The dashboard includes:
- Service status and health
- Request rate and latency percentiles
- Generation performance metrics
- Error rates and active requests
- Streaming performance metrics

### Alerting Rules

Alerting rules are configured at:
`stacks/common/monitoring/config/prometheus/rules/mistral-alerts.yml`

Alerts include:
- **MistralHighLatency** - p95 latency > 5s
- **MistralVeryHighLatency** - p95 latency > 10s
- **MistralHighErrorRate** - Error rate > 5%
- **MistralDown** - Service unavailable
- **MistralHighActiveRequests** - Active requests > 50
- **MistralSlowGeneration** - Generation time > 30s
- **MistralNoRequests** - No requests for 10 minutes

## Testing

Run the monitoring test script:
```bash
cd stacks/mistral
./test-monitoring.sh
```

This script will:
1. Check all monitoring endpoints
2. Verify metrics are being exposed
3. Test Prometheus scraping
4. Generate test traffic
5. Provide links to dashboards

## Accessing Dashboards

1. **Prometheus**: http://localhost:9090
   - Check targets at http://localhost:9090/targets
   - Query metrics directly

2. **Grafana**: http://localhost:3000
   - Default login: admin/changeme
   - Navigate to Dashboards → Mistral.rs Metrics

## Troubleshooting

### Metrics not appearing
1. Ensure the Mistral proxy is running: `docker ps | grep mistral-ollama-proxy`
2. Check metrics endpoint: `curl http://localhost:11434/metrics`
3. Verify Prometheus target is up: http://localhost:9090/targets

### Dashboard not loading
1. Check Grafana is running: `docker ps | grep grafana`
2. Verify dashboard file exists in mounted volume
3. Restart Grafana if needed: `docker restart frontier-grafana`

### Alerts not firing
1. Check rule syntax: `docker exec frontier-prometheus promtool check rules /etc/prometheus/rules/mistral-alerts.yml`
2. Verify rules are loaded: http://localhost:9090/rules
3. Check evaluation: http://localhost:9090/alerts

## Development

To add new metrics:
1. Update `stacks/mistral/api-proxy/src/metrics.rs`
2. Record metrics in appropriate handlers
3. Rebuild proxy: `docker-compose build mistral-ollama-proxy`
4. Update dashboard and alerts as needed